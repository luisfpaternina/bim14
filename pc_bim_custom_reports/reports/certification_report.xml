<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="certification_concept_extra_level_2">
        <t t-if="subchapter_level.type == 'chapter'">
            <tr class="resource_row" style="font-style: italic;">
                 <tr style="background-color: #E5E5E5;" class="parent_row">
                        <td class="text-left">
                            <i t-attf-class="fa fa-{{'th-large text-success'}} mr-2 ml-{{pos}} float-left"/><em><span t-field="subchapter_level.code"/></em>
                        </td>
                        <td class="text-left"><em><strong><span t-field="subchapter_level.name"/></strong></em></td>
                        <td class="text-center"><em>-</em></td>
                        <td class="text-center"><em>-</em></td>
                        <td class="text-center"><em>-</em></td>
                        <td class="text-right">
                            <em><span t-field="subchapter_level.balance_cert"/></em>
                        </td>
                </tr>
            </tr>
        </t>
        <t t-if="subchapter_level.type == 'departure'">
                <tr class="child_row">
                    <td class="text-left">
                        <i t-attf-class="fa fa-{{'th-list text-warning'}} mr-2 ml-{{pos}} float-left"/><span t-field="subchapter_level.code"/>
                    </td>
                    <td><span t-field="subchapter_level.name"/></td>
                    <td><span t-field="subchapter_level.uom_id"/></td>
                    <td class="text-center"><span t-field="subchapter_level.quantity_cert" /></td>
                    <td class="text-right"><span t-field="subchapter_level.amount_compute_cert"/></td>
                    <td class="text-right"><span t-field="subchapter_level.balance_cert" /></td>
                </tr>
        </t>
    </template>
    <template id="certification_report_2">
        <t t-call="web.html_container">
          <t t-foreach="docs" t-as="o">
            <t t-call="base_bim_2.bim_header_external_layout">
              <div class="page">
                <style  type="text/css">
                  th, td {
                    vertical-align: middle !important;
                  }
                </style>
                <h3 class="text-center">GENERAL CERTIFICATION REPORT</h3>
                <t t-set="budget" t-value="o.budget_id"/>
                <table class="table table-sm" style="width:100%;">
                    <tr>
                        <th class="text-center" style="border:1px solid black;width:40%;">PROJECT</th>
                        <th class="text-center text-uppercase" style="border:1px solid black;width:40%;"><span t-field="budget.name"/></th>
                        <th class="text-center" style="border:1px solid black;width:20%;">PRINTING DATE</th>
                    </tr>
                    <tr>
                        <td class="text-center"><span t-field="budget.project_id"/></td>
                        <td class="text-center"><span t-field="budget.display_name"/></td>
                        <td class="text-center"><span t-esc="datetime.datetime.now().strftime('%d/%m/%Y')"/></td>
                    </tr>
                </table>
                <t t-if="o.text">
                     <div class="row pt-1 pb-auto" >
                       <div class="col-12 text-justify">
                          <span t-raw="budget.header_notes"/>
                       </div>
                    </div>
                </t>
                <div class="row">
                    <table class="table table-sm main_table" style="font-size:10px;width:100%;">
                        <thead>
                            <tr>
                                <th style="width:15%;">CODE</th>
                                <th>CONCEPT</th>
                                <th class="text-center">UNIT</th>
                                <th class="text-center">QUANTITY</th>
                                <th class="text-right">PRICE</th>
                                <th class="text-right">AMOUNT</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-set="chapters" t-value="budget.concept_ids.filtered(lambda c: not c.parent_id and c.balance_cert > 0)"/>
                            <t t-set="total" t-value="0"/>
                            <t t-foreach="chapters" t-as="chapter" class="active">
                                <tr style="background-color: #E5E5E5;" class="parent_row">
                                    <td class="text-left">
                                        <i t-attf-class="fa fa-{{'th-large text-success' if chapter.type == 'chapter' else 'th-list text-warning' if chapter.type == 'departure' else 'male text-success'}} mr-2 float-left"/><em><span t-field="chapter.code"/></em>
                                    </td>
                                    <td class="text-left"><em><strong><span t-field="chapter.name"/></strong></em></td>
                                    <td class="text-center"><em>-</em></td>
                                    <td class="text-center"><em>-</em></td>
                                    <td class="text-center"><em>-</em></td>
                                    <td class="text-right">
                                        <em><span t-field="chapter.balance_cert"/></em>
                                    </td>
                                </tr>
                                <t t-set="total" t-value="total+chapter.balance_cert"/>
                                <t t-set="cert_childs" t-value="chapter.child_ids.filtered(lambda c: (c.type == 'departure' and c.to_certify and c.balance_cert > 0) or (c.type == 'chapter' and c.parent_id and c.balance_cert > 0))"/>
                                <t t-foreach="cert_childs" t-as="child">
                                    <t t-set="pos" t-value="2"/>
                                    <t t-if="child.type == 'chapter'">
                                        <t t-call="base_bim_2.certification_concept_extra_level">
                                            <t t-set="subchapter_level" t-value="child"/>
                                        </t>
                                        <t t-if="child.child_ids" t-foreach="child.child_ids.filtered(lambda c: (c.type == 'departure' and c.to_certify and c.balance_cert > 0) or (c.type == 'chapter' and c.parent_id))" t-as="subcharter2">
                                            <t t-call="base_bim_2.certification_concept_extra_level">
                                                <t t-set="subchapter_level" t-value="subcharter2"/>
                                                <t t-set="pos" t-value="3"/>
                                            </t>
                                            <t t-if="subcharter2.child_ids" t-foreach="subcharter2.child_ids.filtered(lambda c: (c.type == 'departure' and c.to_certify and c.balance_cert > 0) or (c.type == 'chapter' and c.parent_id))" t-as="subcharter3">
                                                <t t-call="base_bim_2.certification_concept_extra_level">
                                                    <t t-set="subchapter_level" t-value="subcharter3"/>
                                                    <t t-set="pos" t-value="4"/>
                                                </t>
                                                <t t-if="subcharter3.child_ids" t-foreach="subcharter3.child_ids.filtered(lambda c: (c.type == 'departure' and c.to_certify and c.balance_cert > 0) or (c.type == 'chapter' and c.parent_id))" t-as="subcharter4">
                                                    <t t-call="base_bim_2.certification_concept_extra_level">
                                                        <t t-set="subchapter_level" t-value="subcharter4"/>
                                                        <t t-set="pos" t-value="5"/>
                                                    </t>
                                                </t>
                                            </t>
                                        </t>
                                    </t>
                                    <t t-if="child.type == 'departure'">
                                        <tr class="child_row">
                                            <td class="text-left">
                                                <i t-attf-class="fa fa-{{'th-list text-warning'}} mr-2 ml-{{pos}} float-left"/><span t-field="child.code"/>
                                            </td>
                                            <td><span t-field="child.name"/></td>
                                            <td><span t-field="child.uom_id"/></td>
                                            <td class="text-center"><span t-field="child.quantity_cert" /></td>
                                            <td class="text-right"><span t-field="child.amount_compute_cert"/></td>
                                            <td class="text-right"><span t-field="child.balance_cert" /></td>
                                        </tr>
                                    </t>
                                    <tr t-if="o.text">
                                        <td colspan="1"></td>
                                        <td colspan="5" style="text-align:justify;"><span t-field="child.note"/></td>
                                    </tr>
                                </t>
                            </t>
                            <tr style="background-color: #BFBFBF; font-size: 12px;">
                                <td colspan="1" style="text-align:center;"><strong>TOTAL</strong></td>
                                <td colspan="4"></td>
                                <td colspan="1" style="text-align:right;"><strong><span t-esc="total" t-options="{'widget': 'monetary', 'display_currency': budget.currency_id}"/></strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <t>
                     <!-- TOTALES CON FILTRO -->
                <t t-if="o.filter_ok">
                    <t t-set="total_filter" t-value="o.get_total_filter()"/>

                    <table class="pull-right" style="width:40%;align:right">
                        <t>
                            <tr t-if="total_filter['MT']">
                                <td class="text-left" colspan="5"><strong>Total Materiales</strong></td>
                                <td class="text-right" colspan="2"><strong><span t-esc="total_filter['MT']" t-options="{'widget': 'monetary', 'display_currency': budget.currency_id}"/></strong></td>
                            </tr>

                            <tr t-if="total_filter['MO'] > 0">
                                <td class="text-left" colspan="5"><strong>Total Mano de Obra</strong></td>
                                <td class="text-right" colspan="2"><strong><span t-esc="total_filter['MO']" t-options="{'widget': 'monetary', 'display_currency': budget.currency_id}"/></strong></td>
                            </tr>

                            <tr t-if="total_filter['EQ'] > 0">
                                <td class="text-left" colspan="5"><strong>Total Equipos</strong></td>
                                <td class="text-right" colspan="2"><strong><span t-esc="total_filter['EQ']" t-options="{'widget': 'monetary', 'display_currency': budget.currency_id}"/></strong></td>
                            </tr>

                            <tr t-if="total_filter['AX'] > 0">
                                <td class="text-left" colspan="5"><strong>Otros</strong></td>
                                <td class="text-right" colspan="2"><strong><span t-esc="total_filter['AX']" t-options="{'widget': 'monetary', 'display_currency': budget.currency_id}"/></strong></td>
                            </tr>
                            <tr class="border-black o_subtotal">
                                <td class="text-left" colspan="5"><strong>TOTAL</strong></td>
                                <td class="text-right" colspan="2"><strong><span t-esc="total_filter['MT']+total_filter['MO']+total_filter['EQ']+total_filter['AX']" t-options="{'widget': 'monetary', 'display_currency': budget.currency_id}"/></strong></td>
                            </tr>
                        </t>
                    </table>
                </t>

                <!-- TOTALES SIN FILTRO -->
                <t t-if="not o.filter_ok">
                    <table class="pull-right" style="width:40%;align:right">
                        <t t-if="o.total_type == 'asset' and budget.asset_ids">
                            <t t-foreach="budget.asset_ids" t-as="asset">
                                <tr t-if="asset.asset_id.show_on_report">
                                    <td class="text-left" colspan="5"><strong><span t-field="asset.asset_id.desc"/></strong></td>
                                    <td class="text-right" colspan="2"><strong><span t-esc="asset.total" t-options="{'widget': 'monetary', 'display_currency': budget.currency_id}"/></strong></td>
                                </tr>
                            </t>
                        </t>

                        <t t-if="not budget.asset_ids or o.total_type == 'normal'">
                            <t t-set="MT" t-value="round(o.get_total('material'),2)"/>
                            <tr t-if="MT > 0" style="">
                                <td class="text-left" colspan="5"><strong>Total Materiales</strong></td>
                                <td class="text-right" colspan="2"><strong><span t-esc="MT" t-options="{'widget': 'monetary', 'display_currency': budget.currency_id}"/></strong></td>
                            </tr>

                            <t t-set="MO" t-value="round(o.get_total('labor'),2)"/>
                            <tr t-if="MO > 0">
                                <td class="text-left" colspan="5"><strong>Total Mano de Obra</strong></td>
                                <td class="text-right" colspan="2"><strong><span t-esc="MO" t-options="{'widget': 'monetary', 'display_currency': budget.currency_id}"/></strong></td>
                            </tr>

                            <t t-set="EQ" t-value="round(o.get_total('equip'),2)"/>
                            <tr t-if="EQ > 0">

                                <td class="text-left" colspan="5"><strong>Total Equipos</strong></td>
                                <td class="text-right" colspan="2"><strong><span t-esc="EQ" t-options="{'widget': 'monetary', 'display_currency': budget.currency_id}"/></strong></td>
                            </tr>

                            <t t-set="AX" t-value="round(o.get_total('aux'),2)"/>
                            <tr t-if="AX > 0">
                                <td class="text-left" colspan="5"><strong>Otros</strong></td>
                                <td class="text-right" colspan="2"><strong><span t-esc="budget.balance-(MT+MO+EQ)" t-options="{'widget': 'monetary', 'display_currency': budget.currency_id}"/></strong></td>
                            </tr>
                            <tr class="border-black o_subtotal">
                                <td class="text-left" colspan="5"><strong>TOTAL</strong></td>
                                <td class="text-right" colspan="2"><strong><span t-field="budget.balance"/></strong></td><!--(MT+MO+EQ+AX)-->
                            </tr>
                        </t>
                    </table>
                </t>

                <t t-if="o.notes_ok">
                     <div class="row pt-1 pb-auto" >
                       <div class="col-12 text-justify">
                          <span t-raw="budget.obs" style="line-height:11pt;"/>
                       </div>
                    </div>
                </t>
                </t>
              </div>
            </t>
          </t>
        </t>
    </template>
    <report
            id="report_template_certification_lic"
            string="Reporte CertificaciÃ³n licitaciones"
            model="bim.certification.report.wizard2"
            report_type="qweb-pdf"
            name="pc_bim_custom_reports.certification_report_2"
        />
</odoo>
